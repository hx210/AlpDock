env:
  version: v3.18
  TOOLCHAIN_TAG: temp  

name: Alpine ISO Builder

on:
  push:
    tags:
    - 'v*'
  workflow_dispatch:    

jobs:
  build_ISOs:
    runs-on: ubuntu-latest
    container:
      image: alpine:${{ env.version }}

    steps:
      - uses: actions/checkout@v3

      - name: Install software
        run: |
          apk update
          apk upgrade
          apk --no-cache add alpine-sdk build-base apk-tools alpine-conf \
              busybox fakeroot syslinux xorriso squashfs-tools sudo mtools \
              dosfstools grub-efi

      - name: Download aports
        run: git clone --single-branch https://gitlab.alpinelinux.org/alpine/aports.git

      - name: Configure build keys
        run: echo | abuild-keygen -i -a

      - name: Make ISO (${{ env.version }})
        run: |
          chmod +x *.sh
          mv *.sh aports/scripts/

          aports/scripts/mkimage.sh \
              --tag ${version} \
              --arch x86_64 \
              --profile docker \
              --outdir . \
              --repository https://dl-cdn.alpinelinux.org/alpine/${version}/main \
              --repository https://dl-cdn.alpinelinux.org/alpine/${version}/community


      - name: 上传镜像文件
        uses: ncipollo/release-action@v1
        with:
          name: temp
          allowUpdates: true
          replacesArtifacts: true
          tag: ${{ env.version }}
          commit: ${{ env.CURRENT_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "*.iso"
